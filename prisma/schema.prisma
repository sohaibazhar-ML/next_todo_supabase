generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
  schemas  = ["public"]
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model documents {
  id                 String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  title              String
  description        String?
  category           String
  tags               String[]
  file_name          String
  file_path          String
  file_size          BigInt
  file_type          String
  mime_type          String
  version            String?         @default("1.0")
  parent_document_id String?         @db.Uuid
  is_active          Boolean?        @default(true)
  is_featured        Boolean?        @default(false)
  download_count     Int?            @default(0)
  searchable_content String?
  created_at         DateTime?       @default(now()) @db.Timestamptz(6)
  updated_at         DateTime?       @default(now()) @db.Timestamptz(6)
  created_by         String?         @db.Uuid
  // Note: created_by references auth.users.id, but we don't include auth schema in Prisma
  // Use Supabase client for auth operations
  documents          documents?      @relation("documentsTodocuments", fields: [parent_document_id], references: [id], onUpdate: NoAction)
  other_documents    documents[]     @relation("documentsTodocuments")
  download_logs      download_logs[]
  user_document_versions user_document_versions[]

  @@index([category], map: "idx_documents_category")
  @@index([category, created_at(sort: Desc)], map: "idx_documents_category_created")
  @@index([created_by], map: "idx_documents_created_by")
  @@index([file_type], map: "idx_documents_file_type")
  @@index([is_active], map: "idx_documents_is_active")
  @@index([is_featured], map: "idx_documents_is_featured")
  @@index([parent_document_id], map: "idx_documents_parent_document_id")
  @@index([parent_document_id, category], map: "idx_documents_parent_category")
  @@index([parent_document_id, file_type], map: "idx_documents_parent_file_type")
  @@index([tags], map: "idx_documents_tags_gin", type: Gin)
  @@schema("public")
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model download_logs {
  id            String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  document_id   String    @db.Uuid
  user_id       String    @db.Uuid
  downloaded_at DateTime? @default(now()) @db.Timestamptz(6)
  ip_address    String?   @db.Inet
  user_agent    String?
  context       String?
  metadata      Json?
  documents     documents @relation(fields: [document_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  // Note: user_id references auth.users.id, but we don't include auth schema in Prisma
  // Use Supabase client for auth operations

  @@index([document_id, downloaded_at(sort: Desc)], map: "idx_download_logs_document_id")
  @@index([document_id, user_id], map: "idx_download_logs_document_user")
  @@index([downloaded_at(sort: Desc)], map: "idx_download_logs_downloaded_at")
  @@index([user_id, downloaded_at(sort: Desc)], map: "idx_download_logs_user_id")
  @@schema("public")
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model profiles {
  id                      String    @id @db.Uuid
  username                String    @unique
  first_name              String
  last_name               String
  current_address         String
  country_of_origin       String
  email                   String
  phone_number            String
  number_of_adults        Int       @default(1)
  number_of_children      Int       @default(0)
  pets_type               String?
  new_address_switzerland String
  marketing_consent       Boolean   @default(false)
  terms_accepted          Boolean   @default(false)
  data_privacy_accepted   Boolean   @default(false)
  email_confirmed         Boolean   @default(false)
  email_confirmed_at      DateTime? @db.Timestamptz(6)
  keep_me_logged_in       Boolean   @default(true)
  role                    String    @default("user")
  created_at              DateTime  @default(now()) @db.Timestamptz(6)
  updated_at              DateTime  @default(now()) @db.Timestamptz(6)
  // Note: id references auth.users.id, but we don't include auth schema in Prisma
  // Use Supabase client for auth operations

  subadmin_permissions subadmin_permissions?

  @@index([email], map: "idx_profiles_email")
  @@index([role], map: "idx_profiles_role")
  @@index([role, created_at(sort: Desc)], map: "idx_profiles_role_created")
  @@index([username], map: "idx_profiles_username")
  @@schema("public")
}

/// User-specific document versions for edited documents
model user_document_versions {
  id                   String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  original_document_id String    @db.Uuid
  user_id              String    @db.Uuid
  version_number       Int       @default(1)
  version_name         String?
  
  // For DOCX: Store edited HTML content
  html_content         String?   @db.Text
  
  // For PDF: Store extracted text and annotations
  pdf_text_content     String?   @db.Text
  pdf_annotations      Json?     // Array of annotations: [{ page: number, type: string, x: number, y: number, text: string }]
  
  // Exported file path (if user exports edited version)
  exported_file_path   String?
  exported_file_size   BigInt?
  exported_mime_type   String?
  
  // Original file reference
  original_file_type   String    // "pdf" or "document" (for docx)
  
  // Metadata
  is_draft             Boolean   @default(true)
  created_at           DateTime  @default(now()) @db.Timestamptz(6)
  updated_at           DateTime  @default(now()) @db.Timestamptz(6)
  
  documents            documents @relation(fields: [original_document_id], references: [id], onDelete: Cascade)
  
  @@unique([original_document_id, user_id, version_number])
  @@index([user_id])
  @@index([original_document_id, user_id])
  @@index([user_id, created_at(sort: Desc)])
  @@schema("public")
}

/// Subadmin permissions for granular access control
model subadmin_permissions {
  id                   String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id              String    @unique @db.Uuid
  can_upload_documents Boolean   @default(false)
  can_view_stats       Boolean   @default(false)
  is_active            Boolean   @default(true)
  created_at           DateTime  @default(now()) @db.Timestamptz(6)
  updated_at           DateTime  @default(now()) @db.Timestamptz(6)
  profiles             profiles  @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id])
  @@index([is_active])
  @@schema("public")
}
